<!DOCTYPE HTML SYSTEM "http://www.w3.org/TR/REC-html40/strict.dtd">
<html>
<head>
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Inconsolata" />
    <link rel="stylesheet" type="text/css" href=style.css>
</head>
<body>
    <h1>Install K-portal in AWS EC2 instance</h1>
    <table>
        <thead>
        <tr>
            <th>#</th>
            <th width="32%">Required</th>
            <th width="32%">Local</th>
            <th width="32%">EC2</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td>&nbsp;</td>
            <td>Docker on local machine or AWS CLI installed</td>
            <td>Run AWS CLI in Docker container<br /><code>$ docker run -ti --rm --name aws -v $(pwd):/aws aws</code></td>
            <td></td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td>AWS root key</td>
            <td>Configure AWS CLI with root key</td>
            <td></td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td></td>
            <td>[ Create Key Pair ]</td>
            <td></td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td></td>
            <td>[ Create Security Group ] <note>Open ports 22, [80], 9004, 9005</note></td>
            <td></td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td></td>
            <td>Launch instance
            <note>Use Ubuntu ImageID: ami-a21529cc, InstanceType: t2.small</note></td>
            <td></td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td></td>
            <td></td>
            <td>Copy installation files into VM.
            <br />
            <note>Use sync_up.sh script.</note></td>
        </tr>            
        <tr>
            <td>&nbsp;</td>
            <td></td>
            <td></td>
            <td>Run installation script for Ubuntu
            <note><code>$&nbsp;./installkportal_ubuntu.sh</code></note></td>            
        </tr>
        <tr class="inscript">
            <td>&nbsp;</td>
            <td></td>
            <td></td>
            <td>Create user "kportal"</td>
        </tr>
        <tr class="inscript">
            <td>&nbsp;</td>
            <td></td>
            <td></td>
            <td>Create directories /home/kportal/log and /home/kportal/.ssh/kportal</td>
        </tr>
        <tr class="inscript">
            <td>&nbsp;</td>
            <td></td>
            <td></td>
            <td>Build kp_server</td>
        </tr>
        <tr class="inscript">
            <td>&nbsp;</td>
            <td></td>
            <td></td>
            <td>Install Docker. Start Docker daemon.<br />Use socat for connecting port 9555 to Docker socket.<br/><note>Use start_server.sh</note></td>
        </tr>
        <tr class="inscript">
            <td>&nbsp;</td>
            <td></td>
            <td></td>
            <td>Create group "docker". chown /var/run/docker.sock to group "docker". Add user kportal to group "docker".</td>
        </tr>    
        <tr class="inscript">
            <td>&nbsp;</td>
            <td></td>
            <td></td>
            <td>Install Apache in container using Dockerfile<br />
                <code>docker build --rm -t apachessl .</code></td>
        </tr>
        <tr class="inscript">
            <td>&nbsp;</td>
            <td></td>
            <td></td>
            <td>Start Apache<br />
                <code>docker run -d -p 80:80 -p 9005:443 -v /etc/kportal/www:/etc/kportal/www --name apache apachessl</code></td>
        </tr>
        <tr class="inscript">
            <td>&nbsp;</td>
            <td></td>
            <td></td>
            <td>Import Master Base Image</td>
        <tr class="inscript">
            <td>&nbsp;</td>
            <td></td>
            <td></td>
            <td>Build Apps base image</td>
        </tr>
        <tr class="inscript">
            <td>&nbsp;</td>
            <td></td>
            <td></td>
            <td>Edit kp_server config file /etc/kportal/kportal_conf.xml <note>Use name and ID of Apps base image.</note></td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td>fixed IP and DNS address</td>
            <td></td>
            <td>[ Create SSL certificate ]</td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td>Google account and DNS address</td>
            <td></td>
            <td>Create new credentials for Google API. 
                <a href="https://console.developers.google.com/apis/credentials">Google API</a><br />
                <note>Need hostname.</note></td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td>clientID</td>
            <td></td>
            <td>Use client ID and hostname in configuration file /etc/kportal/www/config.xml.</td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td></td>
            <td></td>
            <td>Start kp_server</td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td></td>
            <td></td>
            <td>Register provider at K-portal.</td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td colspan="3" align="center">Copy public SSH key to K account.</td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td></td>
            <td></td>
            <td>Prepare files for K-portal application (App).<br />
            <note>Application files and job script template. Optionally: App image (png).</note></td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td></td>
            <td></td>
            <td>Build App Docker image based on Apps base image (ubuntu_base).</td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td></td>
            <td></td>
            <td>Save App image to tar.</td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td></td>
            <td></td>
            <td>Upload tar to K-portal.<br />Logint to K-portal as provider and use image management menu.</td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        </tbody>
    </table>
</body>
</html>